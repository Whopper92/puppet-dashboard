From e17269f4f78c9868a20d2e46b4d3ffd2b6fa175b Mon Sep 17 00:00:00 2001
From: Moses Mendoza <moses@puppetlabs.com>
Date: Fri, 15 Jun 2012 13:47:01 -0700
Subject: [PATCH] Patch puppet-dashboard for CVE-2012-2660

This commit adds a patch to actionpack to address
CVE-2012-2660, unsafe query generation vulnerability. This
patch is taken from Aaron Patterson on the rails security list:
https://groups.google.com/forum/?fromgroups#!topic/rubyonrails-security/8SA-M3as7A8

Signed-off-by: Moses Mendoza <moses@puppetlabs.com>
---
 .../actionpack/lib/action_controller/request.rb    |   23 ++++++++++++++++++++
 1 files changed, 23 insertions(+), 0 deletions(-)

diff --git a/vendor/rails/actionpack/lib/action_controller/request.rb b/vendor/rails/actionpack/lib/action_controller/request.rb
index dc46253..659e0ec 100755
--- a/vendor/rails/actionpack/lib/action_controller/request.rb
+++ b/vendor/rails/actionpack/lib/action_controller/request.rb
@@ -464,6 +464,29 @@ EOM
       @env['SERVER_PORT'].to_i
     end
 
+    # Address CVE-2102-2660
+    # Source: https://groups.google.com/forum/?fromgroups#!topic/rubyonrails-security/8SA-M3as7A8
+    protected
+      # Remove nils from the params hash
+      def deep_munge(hash)
+        hash.each_value do |v|
+          case v
+          when Array
+            v.grep(Hash) { |x| deep_munge(x) }
+          when Hash
+            deep_munge(v)
+          end
+        end
+
+        keys = hash.keys.find_all { |k| hash[k] == [nil] }
+        keys.each { |k| hash[k] = nil }
+        hash
+      end
+
+      def parse_query(qs)
+        deep_munge(super)
+      end
+
     private
       def named_host?(host)
         !(host.nil? || /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.match(host))
-- 
1.7.7.6

